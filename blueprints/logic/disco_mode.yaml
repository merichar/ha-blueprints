blueprint:
  name: "Logic: Disco Mode"
  description: "Rapidly cycles every light in selected areas to a unique, 100% saturated random color."
  domain: script
  input:
    target_areas:
      name: Areas or Groups
      selector:
        target:
          entity:
            domain: light
    brightness_level:
      name: Brightness
      default: 100
      selector:
        number: { min: 1, max: 100, unit_of_measurement: "%" }
    transition_time:
      name: Transition Speed
      default: 0.3
      selector:
        number: { min: 0.1, max: 2, step: 0.1, unit_of_measurement: "s" }
    delay_time:
      name: Refresh Rate
      default: 0.8
      selector:
        number: { min: 0.1, max: 5, step: 0.1, unit_of_measurement: "s" }

sequence:
  - variables:
      targets: !input target_areas
      all_entities: >
        {% set entities = area_entities(targets.area_id) if targets.area_id is string else [] %}
        {% if targets.area_id is list %}
          {% for area in targets.area_id %}
            {% set entities = entities + area_entities(area) %}
          {% endfor %}
        {% endif %}
        {% if targets.entity_id is string %}
          {% set entities = entities + [targets.entity_id] %}
        {% elif targets.entity_id is list %}
          {% set entities = entities + targets.entity_id %}
        {% endif %}
        {{ entities | select('match', 'light.') | unique | list }}
      color_lights: >
        {{ all_entities | select('is_state_attr', 'supported_color_modes', 'hs') | list }}
      strobe_lights: >
        {{ all_entities | reject('is_state_attr', 'supported_color_modes', 'hs') | list }}
      brightness: !input brightness_level
      delay_secs: !input delay_time
      transition_secs: !input transition_time

  - repeat:
      while:
        - condition: template
          value_template: "{{ true }}"
      sequence:
        # Batch update all color-capable lights
        - if:
            - condition: template
              value_template: "{{ color_lights | count > 0 }}"
          then:
            - service: light.turn_on
              target:
                entity_id: "{{ color_lights }}"
              data:
                brightness_pct: "{{ brightness }}"
                hs_color:
                  - "{{ range(0, 360) | random }}"
                  - 100
                transition: "{{ transition_secs }}"
        
        # Batch update all white/non-color lights to "strobe"
        - if:
            - condition: template
              value_template: "{{ strobe_lights | count > 0 }}"
          then:
            - service: light.turn_on
              target:
                entity_id: "{{ strobe_lights }}"
              data:
                brightness_pct: "{{ [0, brightness | int] | random }}"
                transition: 0.1
        
        - delay:
            seconds: "{{ delay_secs }}"
mode: restart
